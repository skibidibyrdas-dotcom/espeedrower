<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Speedrower League Junior</title>
<link rel="icon" href="data:,"/>
<style>
  :root{
    --bg:#040406; --card:#0e0f11; --muted:#9aa0a6;
    --g1:#7ff08a; --g2:#b070ff; --glass: rgba(255,255,255,0.03);
    --radius:14px; --maxw:1200px; --accentText:#081011;
  }
  *{box-sizing:border-box}
  body{
    margin:0;font-family:Inter,system-ui,Arial,sans-serif;color:#eef3f6;
    background:
      radial-gradient(1200px 600px at 10% 10%, rgba(127,240,138,0.05), transparent 6%),
      radial-gradient(1000px 500px at 90% 85%, rgba(176,112,255,0.04), transparent 6%),
      linear-gradient(180deg,#020203,var(--bg));
    -webkit-font-smoothing:antialiased;min-height:100vh;
  }
  .wrap{max-width:var(--maxw);margin:20px auto;padding:18px}
  .hero{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    background:linear-gradient(90deg,var(--g1),var(--g2));
    border-radius:18px;padding:18px;color:#fff;box-shadow:0 18px 50px rgba(0,0,0,0.45);
  }
  .logo{display:flex;align-items:center;gap:12px}
  .logo svg{width:56px;height:56px;flex:0 0 56px}
  .hero h1{margin:0;font-size:20px;line-height:1;color:#fff;font-weight:900;text-shadow:0 6px 22px rgba(0,0,0,0.45)}
  .hero .small{color:rgba(255,255,255,0.95);margin-top:6px;font-weight:600}
  nav{display:flex;flex-wrap:wrap;gap:8px;margin:14px 0}
  .btn{background:#fff;color:var(--accentText);padding:8px 12px;border-radius:12px;border:none;cursor:pointer;font-weight:800}
  .btn-ghost{background:transparent;color:inherit;padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);padding:14px;border-radius:14px;border:1px solid var(--glass);box-shadow:0 10px 30px rgba(0,0,0,0.55);transition:transform .18s}
  .card:hover{transform:translateY(-6px)}
  h2{margin:0 0 8px 0}
  .small{font-size:13px;color:var(--muted)}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;margin-top:8px}
  .news-item{border-left:4px solid var(--g2);padding:12px;border-radius:8px;background:linear-gradient(180deg, rgba(176,112,255,0.03), transparent);margin-bottom:12px}
  .news-images{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .news-images img{max-width:160px;border-radius:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.03);transition:transform .18s}
  .news-images img:hover{transform:scale(1.03)}
  .ticker{background:linear-gradient(90deg,rgba(0,0,0,0.12),transparent);padding:8px;border-radius:12px;overflow:hidden;position:relative}
  .ticker .inner{display:inline-block;white-space:nowrap;animation:marquee 14s linear infinite}
  @keyframes marquee{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);font-weight:800;border:1px solid rgba(255,255,255,0.02)}
  .fancyTitle{background:linear-gradient(90deg,var(--g1),var(--g2));-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:900}
  .footer{color:var(--muted);text-align:center;margin:18px 0}
  .hidden{display:none !important}
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:30px;background:linear-gradient(90deg,var(--g1),var(--g2));color:#071011;padding:12px 18px;border-radius:999px;box-shadow:0 12px 40px rgba(0,0,0,0.5);display:none;z-index:20000}
  #confetti{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:20000}
  .club-card{display:flex;flex-direction:column;gap:6px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
  .searchRow{display:flex;gap:8px;align-items:center}
  .statCounter{font-size:20px;font-weight:800}
  table.table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
  th{color:var(--muted);font-weight:700}
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);font-size:12px}

  /* modal basics */
  .modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal[aria-hidden="false"]{display:flex}
  .modal-box{background:var(--card);padding:16px;border-radius:12px;max-width:980px;width:94%;max-height:90%;overflow:auto;border:1px solid var(--glass)}
  /* small responsive tweak */
  @media(max-width:520px){ .modal-box{width:96%;padding:12px} }
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="logo">
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden>
        <defs>
          <linearGradient id="g" x1="0" x2="1">
            <stop offset="0" stop-color="#7ff08a"/>
            <stop offset="1" stop-color="#b070ff"/>
          </linearGradient>
        </defs>
        <rect rx="18" ry="18" width="100" height="100" fill="url(#g)"/>
        <text x="50" y="62" font-family="Arial" font-size="56" text-anchor="middle" fill="#071011" font-weight="900">S</text>
      </svg>
      <div>
        <h1 class="fancyTitle">Speedrower League Junior</h1>
        <div class="small">Liga Junior√≥w ‚Äî terminarz, kluby, aktualno≈õci</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <div class="badge"></div>
      <button id="openPanelBtn" class="btn-ghost" type="button">Panel organizatora</button>
      <a class="btn" href="https://skibidibyrdas-dotcom.github.io/espeedrower/" target="_blank" rel="noopener">Odwied≈∫</a>
    </div>
  </div>

  <div style="margin-top:12px" class="ticker card">
    <div id="tickerInner" class="inner small">≈Åadowanie najbli≈ºszego meczu...</div>
  </div>

  <nav>
    <button class="btn-ghost" data-show="home" type="button">Start</button>
    <button class="btn-ghost" data-show="news" type="button">Aktualno≈õci</button>
    <button class="btn-ghost" data-show="clubs" type="button">Kluby</button>
    <button class="btn-ghost" data-show="schedule" type="button">Terminarz</button>
    <button class="btn-ghost" data-show="standings" type="button">Tabela</button>
  </nav>

  <div class="grid" style="margin-top:12px">
    <main>
      <section id="home" class="card view">
        <h2>Witaj</h2>
        <p class="small">Sprawdzaj mecze , aktualno≈õci i kluby jednym klikniƒôciem!</p>

        <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
          <div class="card" style="min-width:220px;flex:1">
            <div class="small">Szybkie statystyki</div>
            <div style="margin-top:8px">
              <div class="statCounter" id="statClubs">‚Äî</div>
              <div class="small">Kluby</div>
            </div>
          </div>
          <div class="card" style="min-width:220px;flex:1">
            <div class="small">Mecze</div>
            <div style="margin-top:8px">
              <div class="statCounter" id="statMatches">‚Äî</div>
              <div class="small">Mecze</div>
            </div>
          </div>
          <div class="card" style="min-width:220px;flex:1">
            <div class="small">Aktualno≈õci</div>
            <div style="margin-top:8px">
              <div class="statCounter" id="statNews">‚Äî</div>
              <div class="small">News</div>
            </div>
          </div>
        </div>
      </section>

      <section id="news" class="card view hidden">
        <h2 style="color:var(--g2)">Aktualno≈õci</h2>
        <div id="newsList" style="margin-top:12px"></div>
      </section>

      <section id="clubs" class="card view hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <h2>Kluby</h2>
          <div class="searchRow" style="width:320px">
            <input id="clubSearch" placeholder="Szukaj klubu..." />
            <select id="clubFilter"><option value="">Wszystkie kategorie</option><option>U10</option><option>U13</option><option>U16</option><option>U18</option></select>
          </div>
        </div>
        <div id="clubsList" style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px"></div>
      </section>

      <section id="schedule" class="card view hidden">
        <h2>Terminarz</h2>
        <div id="scheduleList" style="margin-top:12px"></div>
      </section>

      <section id="standings" class="card view hidden">
        <h2>Tabela</h2>
        <div id="standingsList" style="margin-top:12px"></div>
      </section>

      <section id="contact" class="card" style="margin-top:12px">
        <h3>Kontakt</h3>
        <p class="small">üìû <strong>792 606 955</strong> ‚Ä¢ üìß <a href="mailto:espeedrower@gmail.com" style="color:var(--g1)">espeedrower@gmail.com</a></p>
      </section>
    </main>

    <aside>
      <div class="card">
        <h4 style="margin:0">Szybkie akcje</h4>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
          <button class="btn" data-show="news" type="button">Aktualno≈õci</button>
          <button class="btn" data-show="clubs" type="button">Kluby</button>
          <button class="btn" data-show="schedule" type="button">Terminarz</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0">Backup</h4>
        <div style="margin-top:8px" class="small">Eksport/Import JSON z bazy (kopie zapasowe).</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="exportAllMain" class="btn" type="button">Eksport</button>
        </div>
      </div>
    </aside>
  </div>

  <div class="footer">¬© 2025 Speedrower League Junior</div>
</div>

<!-- Panel Modal -->
<div id="panelModal" class="modal" aria-hidden="true">
  <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="panelTitle">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong id="panelTitle" style="color:var(--g1)">Panel organizatora</strong>
        <div class="small">Wpisz has≈Ço, aby zarzƒÖdzaƒá</div>
      </div>
      <div><button id="closePanel" class="btn-ghost" type="button">Zamknij</button></div>
    </div>

    <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

    <div id="loginWrap">
      <label class="small">Has≈Ço:</label>
      <input id="adminPass" type="password" class="input" placeholder="Has≈Ço organizatora" />
      <div style="margin-top:8px"><button id="loginBtn" class="btn" type="button">Zaloguj</button></div>
      <div class="small" style="margin-top:8px;color:var(--muted)">Has≈Ço jest sprawdzane lokalnie (mo≈ºemy w przysz≈Ço≈õci dodaƒá Google Sign-In).</div>
    </div>

    <div id="adminControls" class="hidden" style="margin-top:12px">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="card">
          <h4>Dodaj klub</h4>
          <input id="clubName" class="input" placeholder="Nazwa"/>
          <input id="clubCity" class="input" placeholder="Miasto"/>
          <input id="clubShort" class="input" placeholder="Skr√≥t"/>
          <textarea id="clubDesc" class="input" rows="3" placeholder="Opis"></textarea>
          <input id="clubAchievements" class="input" placeholder="OsiƒÖgniƒôcia (oddziel przecinkiem)"/>
          <input id="clubRoster" class="input" placeholder="Sk≈Çad (oddziel przecinkiem)"/>
          <label class="small">Kategorie</label>
          <select id="clubCats" multiple size="4" class="input"><option>U10</option><option>U13</option><option>U16</option><option>U18</option></select>
          <div style="display:flex;gap:8px;margin-top:8px"><button id="saveClub" class="btn" type="button">Zapisz</button><button id="clearClub" class="btn-ghost" type="button">Wyczy≈õƒá</button></div>
        </div>

        <div class="card">
          <h4>Dodaj mecz / wynik</h4>
          <input id="matchDate" class="input" type="date"/>
          <input id="matchTime" class="input" type="time"/>
          <input id="matchHome" class="input" placeholder="Gospodarz"/>
          <input id="matchAway" class="input" placeholder="Go≈õƒá"/>
          <input id="matchPlace" class="input" placeholder="Miejsce"/>
          <select id="matchCat" class="input"><option>U10</option><option>U13</option><option>U16</option><option>U18</option></select>
          <div style="display:flex;gap:8px;margin-top:8px"><input id="matchHomeGoals" class="input" type="number" min="0" placeholder="Gosp - pkt" style="width:48%"/><input id="matchAwayGoals" class="input" type="number" min="0" placeholder="Go≈õƒá - pkt" style="width:48%"/></div>
          <div style="display:flex;gap:8px;margin-top:8px"><button id="saveMatch" class="btn" type="button">Dodaj</button><button id="clearMatch" class="btn-ghost" type="button">Wyczy≈õƒá</button></div>
        </div>

        <div class="card" style="grid-column:1 / -1">
          <h4>Dodaj aktualno≈õƒá (ze zdjƒôciami)</h4>
          <input id="newsTitle" class="input" placeholder="Tytu≈Ç"/>
          <textarea id="newsContent" class="input" rows="3" placeholder="Tre≈õƒá"></textarea>
          <input id="newsFiles" type="file" accept="image/*" multiple class="input"/>
          <div style="display:flex;gap:8px;margin-top:8px"><button id="addNews" class="btn" type="button">Dodaj aktualno≈õƒá</button><button id="clearNews" class="btn-ghost" type="button">Wyczy≈õƒá</button></div>
        </div>
      </div>

      <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="exportAllAdmin" class="btn" type="button">Eksport (JSON)</button>
        <label class="btn-ghost" style="cursor:pointer;padding:8px 10px;border-radius:8px">Import<input id="importAllAdmin" type="file" accept=".json" style="display:none"/></label>
      </div>
    </div>
  </div>
</div>

<div id="toast">Gotowe!</div>
<canvas id="confetti"></canvas>

<!-- App logic + Firebase -->
<script type="module">
/* ========= CONFIG ========== */
const ADMIN_PASS = 'Speedrower';

/* Firebase (unchanged) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNi83_zoH8cDSpYoTS4XtoGLPDKnypG1A",
  authDomain: "speedrower-junior-league.firebaseapp.com",
  projectId: "speedrower-junior-league",
  storageBucket: "speedrower-junior-league.appspot.com",
  messagingSenderId: "151487950214",
  appId: "1:151487950214:web:54742c6cae06f267661007",
  measurementId: "G-BTW6P3QMS3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ========= UI refs (will be initialized on DOMContentLoaded) ========= */
let refs = {};

/* ========= Helpers ========= */
function el(id){ return document.getElementById(id); }
function showToast(msg, t = 3500){ const to = refs.toast; if(!to) return; to.textContent = msg; to.style.display = 'block'; setTimeout(()=> to.style.display = 'none', t); }
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
function uid(p='id'){ return p + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

/* confetti (unchanged) */
function popConfetti(){
  const c = refs.confetti;
  if(!c) return;
  const ctx = c.getContext('2d');
  c.width = innerWidth; c.height = innerHeight;
  const pieces = Array.from({length:60}).map(()=>(({
    x: Math.random()*c.width, y: -20 - Math.random()*200, vx: (Math.random()-0.5)*6, vy: 2+Math.random()*6,
    w: 6+Math.random()*10, h: 6+Math.random()*10, col: Math.random()>0.5 ? '#7ff08a' : '#b070ff', rot: Math.random()*360
  })));
  let t=0;
  const raf = ()=> {
    t++; ctx.clearRect(0,0,c.width,c.height);
    pieces.forEach(p=>{ p.x += p.vx; p.y += p.vy; p.vy += 0.12; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot * Math.PI/180); ctx.fillStyle = p.col; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore(); });
    if(t<160) requestAnimationFrame(raf); else ctx.clearRect(0,0,c.width,c.height);
  };
  raf();
}

/* upload helper (unchanged) */
async function uploadFiles(files){
  if(!files || files.length===0) return [];
  const urls = [];
  for(const f of files){
    const path = `news_images/${Date.now()}_${Math.random().toString(36).slice(2,8)}_${f.name}`;
    const ref = sref(storage, path);
    await uploadBytes(ref, f);
    const url = await getDownloadURL(ref);
    urls.push(url);
  }
  return urls;
}

/* ========= Club rendering/filtering (cleaned) ========= */
let clubsCache = [];
function renderClubs(arr){
  const list = refs.clubsList;
  list.innerHTML = '';
  if(!arr || arr.length === 0){
    list.innerHTML = '<div class="small">Brak klub√≥w dopasowanych do wyszukiwania.</div>';
    return;
  }
  arr.forEach(c=>{
    const div = document.createElement('div');
    div.className = 'club-card';
    div.innerHTML = `
      <strong>${escapeHtml(c.name)}</strong>
      <div class="small">${escapeHtml(c.city||'')} ${c.short?('‚Ä¢ '+escapeHtml(c.short)):""}</div>
      <div style="margin-top:6px" class="small">${(c.categories||[]).join(', ')}</div>
      ${c.description ? `<div style="margin-top:8px">${escapeHtml(c.description)}</div>` : ''}
      ${c.achievements?.length ? `<div style="margin-top:8px"><strong>OsiƒÖgniƒôcia:</strong><div class="small">${escapeHtml(c.achievements.join(', '))}</div></div>` : ''}
      ${c.roster?.length ? `<div style="margin-top:8px"><strong>Sk≈Çad:</strong><div class="small">${escapeHtml(c.roster.join(', '))}</div></div>` : ''}
    `;
    list.appendChild(div);
  });
}

async function loadClubs(){
  try{
    refs.clubsList.innerHTML = '';
    clubsCache = [];
    const snap = await getDocs(collection(db,'kluby'));
    if(snap.empty){ refs.clubsList.innerHTML = '<div class="small">Brak klub√≥w.</div>'; return; }
    snap.forEach(s => { const c = s.data(); c._id = s.id; clubsCache.push(c); });
    renderClubs(clubsCache);
  } catch(e){
    console.error('loadClubs error', e);
    refs.clubsList.innerHTML = '<div class="small">B≈ÇƒÖd wczytywania klub√≥w.</div>';
  }
}

function applyClubFilter(){
  const q = (refs.clubSearch.value||'').toLowerCase().trim();
  const cat = refs.clubFilter.value;
  let res = clubsCache.slice();
  if(cat) res = res.filter(c => (c.categories||[]).includes(cat));
  if(q) res = res.filter(c =>
    (c.name||'').toLowerCase().includes(q) ||
    (c.city||'').toLowerCase().includes(q) ||
    (c.short||'').toLowerCase().includes(q)
  );
  renderClubs(res);
}

/* ========= News / Matches / Standings / Ticker (kept behavior) ========= */
const newsList = () => refs.newsList;
async function loadNews(){
  try{
    refs.newsList.innerHTML = '≈Åadowanie...';
    const q = query(collection(db,'aktualnosci'), orderBy('createdAt','desc'));
    const snap = await getDocs(q);
    refs.newsList.innerHTML = '';
    if(snap.empty){ refs.newsList.innerHTML = '<div class="small">Brak aktualno≈õci.</div>'; return; }
    snap.forEach(d=>{
      const n = d.data();
      const date = n.createdAt && n.createdAt.toDate ? n.createdAt.toDate().toLocaleString() : (n.date||'');
      const div = document.createElement('div'); div.className='news-item';
      let imgs = '';
      if(n.images && n.images.length) imgs = '<div class="news-images">' + n.images.map(u=> `<img src="${u}" onclick="window.open('${u}','_blank')">`).join('') + '</div>';
      div.innerHTML = `<strong>${escapeHtml(n.title)}</strong><div class="small">${date}${n.author?(' ‚Ä¢ '+escapeHtml(n.author)):""}</div><div style="margin-top:8px">${escapeHtml(n.content)}</div>${imgs}`;
      refs.newsList.appendChild(div);
    });
  } catch(e){
    console.error('loadNews error', e);
    refs.newsList.innerHTML = '<div class="small">B≈ÇƒÖd wczytywania aktualno≈õci. Sprawd≈∫ uprawnienia Firestore.</div>';
  }
}

/* Matches */
async function loadMatches(){
  try{
    refs.scheduleList.innerHTML = '';
    const snap = await getDocs(query(collection(db,'mecze'), orderBy('date','asc')));
    if(snap.empty){ refs.scheduleList.innerHTML = '<div class="small">Brak mecz√≥w.</div>'; return; }
    const table = document.createElement('table'); table.className='table';
    table.innerHTML = '<thead><tr><th>Data</th><th>Godz.</th><th>Mecz</th><th>Kategoria</th><th>Miejsce</th><th>Wynik</th><th>Akcje</th></tr></thead>';
    const tb = document.createElement('tbody');
    snap.forEach(s=> {
      const m = s.data();
      const tr = document.createElement('tr');
      const res = (typeof m.homeGoals==='number' && typeof m.awayGoals==='number') ? `${m.homeGoals} : ${m.awayGoals}` : '-';
      tr.innerHTML = `<td>${escapeHtml(m.date||'')}</td><td>${escapeHtml(m.time||'')}</td><td>${escapeHtml(m.home)} ‚Äî ${escapeHtml(m.away)}</td><td>${escapeHtml(m.category||'')}</td><td>${escapeHtml(m.place||'')}</td><td>${res}</td><td></td>`;
      const td = tr.querySelector('td:last-child');
      if(sessionStorage.getItem('sr_admin')==='1'){
        const del = document.createElement('button'); del.className='btn-ghost'; del.textContent='Usu≈Ñ'; del.type='button';
        del.onclick = async ()=> { if(confirm('UsunƒÖƒá mecz?')){ await deleteDoc(doc(db,'mecze',s.id)); await loadMatches(); await renderStandings(); await updateTicker(); } };
        td.appendChild(del);
      }
      tb.appendChild(tr);
    });
    table.appendChild(tb); refs.scheduleList.appendChild(table);
  } catch(e){
    console.error('loadMatches error', e);
    refs.scheduleList.innerHTML = '<div class="small">B≈ÇƒÖd wczytywania terminarza. Sprawd≈∫ uprawnienia Firestore.</div>';
  }
}

/* Standings */
async function renderStandings(){
  try{
    const el = refs.standingsList; el.innerHTML = '';
    const clubsSnap = await getDocs(collection(db,'kluby'));
    const matchesSnap = await getDocs(collection(db,'mecze'));
    if(clubsSnap.empty || matchesSnap.empty){ el.innerHTML = '<div class="small">Brak danych do wylicze≈Ñ.</div>'; return; }
    const map = {};
    clubsSnap.forEach(c => { const d = c.data(); if(d.name) map[d.name] = { club: d.name, MP:0,P:0,W:0,D:0,L:0,GF:0,GA:0,GD:0 }; });
    matchesSnap.forEach(mSnap => {
      const m = mSnap.data();
      if(typeof m.homeGoals!=='number' || typeof m.awayGoals!=='number') return;
      if(!map[m.home] || !map[m.away]) return;
      map[m.home].MP++; map[m.away].MP++;
      map[m.home].GF += m.homeGoals; map[m.home].GA += m.awayGoals;
      map[m.away].GF += m.awayGoals; map[m.away].GA += m.homeGoals;
      if(m.homeGoals>m.awayGoals){ map[m.home].W++; map[m.home].P+=3; map[m.away].L++; }
      else if(m.homeGoals<m.awayGoals){ map[m.away].W++; map[m.away].P+=3; map[m.home].L++; }
      else { map[m.home].D++; map[m.away].D++; map[m.home].P++; map[m.away].P++; }
    });
    Object.values(map).forEach(r=> r.GD = r.GF - r.GA);
    const sorted = Object.values(map).sort((a,b)=> (b.P - a.P) || (b.GD - a.GD) || (b.GF - a.GF));
    const tbl = document.createElement('table'); tbl.className='table';
    tbl.innerHTML = '<thead><tr><th>#</th><th>Klub</th><th>MP</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th></tr></thead>';
    const tbody = document.createElement('tbody');
    sorted.forEach((r,i)=> { const tr = document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(r.club)}</td><td>${r.MP}</td><td>${r.P}</td><td>${r.W}</td><td>${r.D}</td><td>${r.L}</td><td>${r.GF}</td><td>${r.GA}</td><td>${r.GD}</td>`; tbody.appendChild(tr); });
    tbl.appendChild(tbody); refs.standingsList.appendChild(tbl);
  } catch(e){
    console.error('renderStandings error', e);
    refs.standingsList.innerHTML = '<div class="small">B≈ÇƒÖd przy wyliczaniu tabeli. Sprawd≈∫ regu≈Çy Firestore.</div>';
  }
}

/* Ticker */
async function updateTicker(){
  try{
    const snap = await getDocs(query(collection(db,'mecze'), orderBy('date','asc')));
    const arr = [];
    snap.forEach(s=> arr.push(s.data()));
    const now = new Date();
    const upcoming = arr.filter(m => { if(!m.date) return false; const d = new Date(m.date + 'T' + (m.time||'00:00')); return d >= now; }).sort((a,b)=> (a.date+(a.time||'')) > (b.date+(b.time||'')) ? 1 : -1);
    if(upcoming.length===0) refs.tickerInner.textContent = 'Brak zaplanowanych mecz√≥w.';
    else { const m = upcoming[0]; refs.tickerInner.innerHTML = `Najbli≈ºszy: <strong>${escapeHtml(m.home)} ‚Äî ${escapeHtml(m.away)}</strong> ‚Ä¢ ${escapeHtml(m.date)} ${escapeHtml(m.time||'')} ‚Ä¢ ${escapeHtml(m.place||'')}`; }
  } catch(e){
    console.error('updateTicker error', e);
    refs.tickerInner.textContent = 'B≈ÇƒÖd ≈Çadowania terminarza. Sprawd≈∫ uprawnienia Firestore.';
  }
}

/* Export / Import (unchanged) */
async function doExportAll(){
  if(!confirm('Pobraƒá backup wszystkich kolekcji?')) return;
  try {
    const [klubySnap, meczeSnap, newsSnap] = await Promise.all([getDocs(collection(db,'kluby')), getDocs(collection(db,'mecze')), getDocs(collection(db,'aktualnosci'))]);
    const data = { kluby: klubySnap.docs.map(d=>({id:d.id,data:d.data()})), mecze: meczeSnap.docs.map(d=>({id:d.id,data:d.data()})), aktualnosci: newsSnap.docs.map(d=>({id:d.id,data:d.data()})) };
    const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'speedrower_backup.json'; a.click(); URL.revokeObjectURL(url);
  } catch(e){ alert('B≈ÇƒÖd eksportu: '+(e.message||e)); console.error(e); }
}

/* Stats animation */
async function updateStats(){
  try {
    const [klubySnap, meczeSnap, newsSnap] = await Promise.all([getDocs(collection(db,'kluby')), getDocs(collection(db,'mecze')), getDocs(collection(db,'aktualnosci'))]);
    animateCount(refs.statClubs, klubySnap.size);
    animateCount(refs.statMatches, meczeSnap.size);
    animateCount(refs.statNews, newsSnap.size);
  } catch(e){ console.error('updateStats error', e); }
}
function animateCount(el, to){
  const from = Number(el.textContent) || 0;
  const dur = 700; const start = performance.now();
  const raf = (t)=> {
    const p = Math.min(1, (t-start)/dur);
    el.textContent = Math.floor(from + (to-from)*p);
    if(p<1) requestAnimationFrame(raf);
  };
  requestAnimationFrame(raf);
}

/* ========= ADMIN actions (save club, save match, add news, import) ========= */
async function doAddNews(){
  if(sessionStorage.getItem('sr_admin')!=='1') return alert('Zaloguj siƒô has≈Çem w panelu.');
  const title = refs.newsTitle.value.trim();
  const content = refs.newsContent.value.trim();
  const files = refs.newsFiles.files;
  if(!title || !content) return alert('Wype≈Çnij tytu≈Ç i tre≈õƒá.');
  const btn = refs.addNews; btn.disabled=true; btn.textContent='Dodawanie...';
  try {
    const imgs = await uploadFiles(files);
    await addDoc(collection(db,'aktualnosci'), { title, content, images: imgs, author: 'Organizer (has≈Ço)', createdAt: serverTimestamp() });
    refs.newsTitle.value=''; refs.newsContent.value=''; refs.newsFiles.value='';
    showToast('Aktualno≈õƒá dodana'); popConfetti(); await loadNews(); await updateTicker(); await updateStats();
  } catch(e){ alert('B≈ÇƒÖd: '+(e.message||e)); console.error(e); } finally { btn.disabled=false; btn.textContent='Dodaj aktualno≈õƒá'; }
}

async function doSaveClub(){
  if(sessionStorage.getItem('sr_admin')!=='1') return alert('Zaloguj siƒô has≈Çem.');
  const name = refs.clubName.value.trim(); if(!name) return alert('Nazwa klubu wymagana.');
  const data = {
    name,
    city: refs.clubCity.value.trim(),
    short: refs.clubShort.value.trim(),
    description: refs.clubDesc.value.trim(),
    achievements: (refs.clubAchievements.value||'').split(',').map(s=>s.trim()).filter(Boolean),
    roster: (refs.clubRoster.value||'').split(',').map(s=>s.trim()).filter(Boolean),
    categories: Array.from(refs.clubCats.selectedOptions).map(o=>o.value),
    createdAt: serverTimestamp(), author: 'Organizer (has≈Ço)'
  };
  try { await addDoc(collection(db,'kluby'), data); showToast('Dodano klub'); clearClubForm(); await loadClubs(); await updateStats(); } catch(e){ alert('B≈ÇƒÖd: '+(e.message||e)); console.error(e); }
}
function clearClubForm(){ refs.clubName.value=''; refs.clubCity.value=''; refs.clubShort.value=''; refs.clubDesc.value=''; refs.clubAchievements.value=''; refs.clubRoster.value=''; Array.from(refs.clubCats.options).forEach(o=>o.selected=false); }

async function doSaveMatch(){
  if(sessionStorage.getItem('sr_admin')!=='1') return alert('Zaloguj siƒô has≈Çem.');
  const date = refs.matchDate.value;
  const time = refs.matchTime.value;
  const home = refs.matchHome.value.trim();
  const away = refs.matchAway.value.trim();
  const place = refs.matchPlace.value.trim();
  const cat = refs.matchCat.value;
  const hg = refs.matchHomeGoals.value;
  const ag = refs.matchAwayGoals.value;
  if(!date || !home || !away) return alert('Wype≈Çnij datƒô, gospodarza i go≈õcia.');
  const data = { date, time, home, away, place, category:cat, homeGoals: hg===''?null: Number(hg), awayGoals: ag===''?null: Number(ag), createdAt: serverTimestamp(), author: 'Organizer (has≈Ço)' };
  try { await addDoc(collection(db,'mecze'), data); showToast('Mecz dodany'); await loadMatches(); await renderStandings(); await updateTicker(); } catch(e){ alert('B≈ÇƒÖd: '+(e.message||e)); console.error(e); }
}

/* ========= Modal control (robust) ========= */
function showPanel(open){
  const m = refs.panelModal;
  if(!m) return;
  if(open){
    m.setAttribute('aria-hidden','false');
    sessionStorage.setItem('sr_admin', sessionStorage.getItem('sr_admin') === '1' ? '1' : '0'); // keep existing admin flag
    // show admin controls if already logged
    if(sessionStorage.getItem('sr_admin') === '1') {
      refs.loginWrap.classList.add('hidden');
      refs.adminControls.classList.remove('hidden');
    }
    // focus first input
    setTimeout(()=> refs.adminPass && refs.adminPass.focus(), 60);
  } else {
    m.setAttribute('aria-hidden','true');
    // also remove sr_admin if panel closed via explicit close (optional)
    // sessionStorage.removeItem('sr_admin');
  }
}

/* ========= Init & event wiring ========= */
document.addEventListener('DOMContentLoaded', ()=> {
  // populate refs
  refs = {
    openPanelBtn: el('openPanelBtn'),
    panelModal: el('panelModal'),
    closePanel: el('closePanel'),
    loginBtn: el('loginBtn'),
    adminPass: el('adminPass'),
    loginWrap: el('loginWrap'),
    adminControls: el('adminControls'),
    toast: el('toast'),
    confetti: el('confetti'),
    newsList: el('newsList'),
    clubsList: el('clubsList'),
    clubSearch: el('clubSearch'),
    clubFilter: el('clubFilter'),
    scheduleList: el('scheduleList'),
    standingsList: el('standingsList'),
    tickerInner: el('tickerInner'),
    statClubs: el('statClubs'),
    statMatches: el('statMatches'),
    statNews: el('statNews'),
    // admin inputs/buttons
    newsTitle: el('newsTitle'),
    newsContent: el('newsContent'),
    newsFiles: el('newsFiles'),
    addNews: el('addNews'),
    clubName: el('clubName'),
    clubCity: el('clubCity'),
    clubShort: el('clubShort'),
    clubDesc: el('clubDesc'),
    clubAchievements: el('clubAchievements'),
    clubRoster: el('clubRoster'),
    clubCats: el('clubCats'),
    saveClub: el('saveClub'),
    clearClub: el('clearClub'),
    matchDate: el('matchDate'),
    matchTime: el('matchTime'),
    matchHome: el('matchHome'),
    matchAway: el('matchAway'),
    matchPlace: el('matchPlace'),
    matchCat: el('matchCat'),
    matchHomeGoals: el('matchHomeGoals'),
    matchAwayGoals: el('matchAwayGoals'),
    saveMatch: el('saveMatch'),
    clearMatch: el('clearMatch'),
    exportAllMain: el('exportAllMain'),
    exportAllAdmin: el('exportAllAdmin'),
    importAllAdmin: el('importAllAdmin'),
  };

  // basic nav show/hide
  document.querySelectorAll('[data-show]').forEach(b => b.addEventListener('click', (ev) => {
    const id = ev.currentTarget.dataset.show;
    document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  }));
  document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
  document.getElementById('home').classList.remove('hidden');

  // modal open
  refs.openPanelBtn && refs.openPanelBtn.addEventListener('click', () => {
    showPanel(true);
    refs.panelModal.removeAttribute('data-blocked');
    // if logged earlier, show admin controls
    if(sessionStorage.getItem('sr_admin') === '1') {
      refs.loginWrap.classList.add('hidden');
      refs.adminControls.classList.remove('hidden');
    } else {
      refs.loginWrap.classList.remove('hidden');
      refs.adminControls.classList.add('hidden');
    }
  });

  // close button
  refs.closePanel && refs.closePanel.addEventListener('click', ()=> showPanel(false));

  // overlay click closes when clicking the overlay (but not when clicking modal box)
  refs.panelModal && refs.panelModal.addEventListener('click', (ev) => {
    if(ev.target === refs.panelModal) showPanel(false);
  });

  // Escape key closes
  document.addEventListener('keydown', (e) => {
    if(e.key === 'Escape' || e.key === 'Esc') {
      if(refs.panelModal && refs.panelModal.getAttribute('aria-hidden') === 'false') {
        showPanel(false);
      }
    }
  });

  // login button
  refs.loginBtn && refs.loginBtn.addEventListener('click', () => {
    const v = (refs.adminPass.value||'').trim();
    if(!v) return alert('Wpisz has≈Ço.');
    if(v === ADMIN_PASS){
      refs.adminPass.value = '';
      refs.loginWrap.classList.add('hidden');
      refs.adminControls.classList.remove('hidden');
      sessionStorage.setItem('sr_admin','1');
      showToast('Panel odblokowany');
    } else alert('B≈Çƒôdne has≈Ço.');
  });

  // admin actions wiring
  refs.addNews && refs.addNews.addEventListener('click', doAddNews);
  refs.saveClub && refs.saveClub.addEventListener('click', doSaveClub);
  refs.clearClub && refs.clearClub.addEventListener('click', clearClubForm);
  refs.saveMatch && refs.saveMatch.addEventListener('click', doSaveMatch);
  refs.exportAllMain && refs.exportAllMain.addEventListener('click', doExportAll);
  refs.exportAllAdmin && refs.exportAllAdmin.addEventListener('click', doExportAll);
  refs.importAllAdmin && refs.importAllAdmin.addEventListener('change', async (e) => {
    if(sessionStorage.getItem('sr_admin')!=='1') return alert('Zaloguj siƒô has≈Çem.');
    const f = e.target.files[0]; if(!f) return;
    const txt = await f.text();
    try {
      const json = JSON.parse(txt);
      if(json.kluby){ for(const k of json.kluby) await addDoc(collection(db,'kluby'), k.data); }
      if(json.mecze){ for(const m of json.mecze) await addDoc(collection(db,'mecze'), m.data); }
      if(json.aktualnosci){ for(const n of json.aktualnosci) await addDoc(collection(db,'aktualnosci'), n.data); }
      showToast('Import zako≈Ñczony'); await loadClubs(); await loadMatches(); await loadNews(); await renderStandings(); await updateTicker(); await updateStats();
    } catch(err){ alert('B≈ÇƒÖd importu: '+(err.message||err)); console.error(err); }
  });

  // club search/filter wiring
  refs.clubSearch && refs.clubSearch.addEventListener('input', applyClubFilter);
  refs.clubFilter && refs.clubFilter.addEventListener('change', applyClubFilter);

  // Prevent weird duplicate listeners or older code interference: ensure only our panel is visible handling
  refs.panelModal.setAttribute('aria-hidden','true');

  // init data (do not block the UI if some fetch fails)
  Promise.allSettled([ loadNews(), loadClubs(), loadMatches(), renderStandings(), updateTicker(), updateStats() ])
    .then(results => {
      results.forEach(r => { if(r.status === 'rejected') console.warn('init failed:', r.reason); });
    });

  // expose quick debug helpers
  window.sr = { loadNews, loadClubs, loadMatches, renderStandings, updateTicker, updateStats, showPanel };
});

/* Global safety handlers to avoid UI freeze if FB throws permission errors */
window.addEventListener('unhandledrejection', function(ev){
  console.warn('Unhandled rejection (suppressed):', ev.reason);
  try { document.getElementById('toast') && showToast('Problem z serwerem / uprawnieniami. Sprawd≈∫ regu≈Çy Firestore.'); } catch(e){}
  ev.preventDefault();
});
window.addEventListener('error', function(ev){
  console.error('Global error (suppressed):', ev.error || ev.message);
});
</script>
</body>
</html>
