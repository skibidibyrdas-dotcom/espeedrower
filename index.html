<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Speedrower League Junior — panel (hasło)</title>
<style>
:root{--bg:#050506;--card:#0d0f10;--accent1:#7ff08a;--accent2:#b070ff;--muted:#9aa0a6;--radius:12px;--maxw:1100px}
body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#020203,var(--bg));color:#eef3f6;min-height:100vh}
.container{max-width:var(--maxw);margin:18px auto;padding:12px}
.ribbon{padding:12px;border-radius:12px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#071011;font-weight:800;text-align:center}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:12px}
.nav{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
.btn{background:var(--accent1);color:#071011;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.btn-ghost{background:transparent;color:inherit;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
.card{background:var(--card);padding:12px;border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03);margin-bottom:12px}
.small{font-size:13px;color:var(--muted)}
.input,textarea,select{width:100%;padding:9px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;margin-top:8px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
.table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:10px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
.news-images{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.news-images img{max-width:160px;border-radius:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal-box{background:var(--card);padding:16px;border-radius:12px;max-width:980px;width:94%;max-height:90%;overflow:auto;border:1px solid rgba(255,255,255,0.03)}
.hidden{display:none}
.footer{color:var(--muted);text-align:center;margin:18px 0}
</style>
</head>
<body>
<div class="container">
  <div class="ribbon">Speedrower League Junior — panel organizatora (hasło)</div>

  <div class="header">
    <div>
      <h1 style="margin:0">Speedrower League Junior</h1>
      <div class="small">Aktualności • Kluby • Terminarz</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div id="adminStatus" class="small">Panel zamknięty</div>
      <button id="openPanelBtn" class="btn-ghost">Panel organizatora</button>
    </div>
  </div>

  <nav class="nav">
    <button class="btn-ghost" data-show="home">Start</button>
    <button class="btn-ghost" data-show="news">Aktualności</button>
    <button class="btn-ghost" data-show="clubs">Kluby</button>
    <button class="btn-ghost" data-show="schedule">Terminarz</button>
    <button class="btn-ghost" data-show="standings">Tabela</button>
  </nav>

  <div class="grid">
    <main>
      <section id="home" class="card view">
        <h2 style="margin:0;color:var(--accent1)">Witaj</h2>
        <p class="small">Użyj Panelu organizatora, aby dodać aktualności dostępne dla wszystkich. Panel chroniony hasłem.</p>
      </section>

      <section id="news" class="card view hidden">
        <h2 style="margin:0;color:var(--accent2)">Aktualności</h2>
        <div id="newsList" style="margin-top:12px"></div>
      </section>

      <section id="clubs" class="card view hidden">
        <h2 style="margin:0">Kluby</h2>
        <div id="clubsList" style="margin-top:12px"></div>
      </section>

      <section id="schedule" class="card view hidden">
        <h2 style="margin:0">Terminarz</h2>
        <div id="scheduleList" style="margin-top:12px"></div>
      </section>

      <section id="standings" class="card view hidden">
        <h2 style="margin:0">Tabela</h2>
        <div id="standingsList" style="margin-top:12px"></div>
      </section>

      <section id="contact" class="card">
        <h3 style="margin:0">Kontakt</h3>
        <p class="small">📞 792 606 955 • 📧 espeedrower@gmail.com</p>
      </section>
    </main>

    <aside>
      <div class="card">
        <div class="small">Szybkie akcje</div>
        <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
          <button class="btn" data-show="news">Aktualności</button>
          <button class="btn" data-show="clubs">Kluby</button>
          <button class="btn" data-show="schedule">Terminarz</button>
        </div>
      </div>

      <div class="card">
        <div class="small">Backup / Import</div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="exportBtn" class="btn">Eksportuj JSON</button>
          <label class="btn-ghost" style="cursor:pointer"><input id="importFile" type="file" accept=".json" style="display:none">Import JSON</label>
        </div>
      </div>
    </aside>
  </div>

  <footer class="footer">© 2025 Speedrower League Junior</footer>
</div>

<!-- PANEL (modal z hasłem i kontrolkami) -->
<div id="panelModal" class="modal hidden">
  <div class="modal-box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong style="color:var(--accent1)">Panel organizatora</strong><div class="small">Zaloguj hasłem, by zarządzać ligą</div></div>
      <div><button id="closePanel" class="btn-ghost">Zamknij</button></div>
    </div>

    <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

    <div id="loginForm">
      <label class="small">Wpisz hasło organizatora</label>
      <input id="adminPassword" type="password" class="input" placeholder="Hasło"/>
      <div style="margin-top:8px"><button id="loginBtn" class="btn">Zaloguj</button></div>
      <div class="small" style="margin-top:8px;color:var(--muted)">Hasło nie jest wysyłane nigdzie — sprawdzane lokalnie (uwaga: widoczne w źródle strony).</div>
    </div>

    <div id="adminControls" class="hidden" style="margin-top:12px">
      <!-- Dodaj klub / mecz / aktualność -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div class="card">
          <h4>Dodaj klub</h4>
          <input id="clubName" class="input" placeholder="Nazwa klubu"/>
          <input id="clubCity" class="input" placeholder="Miasto"/>
          <input id="clubShort" class="input" placeholder="Skrót"/>
          <textarea id="clubDesc" class="input" rows="3" placeholder="Opis"></textarea>
          <input id="clubAchievements" class="input" placeholder="Osiągnięcia (oddziel przecinkiem)"/>
          <input id="clubRoster" class="input" placeholder="Skład (oddziel przecinkiem)"/>
          <label class="small">Kategorie</label>
          <select id="clubCats" multiple size="4" class="input"><option>U10</option><option>U13</option><option>U16</option><option>U18</option></select>
          <div style="margin-top:8px;display:flex;gap:8px"><button id="saveClub" class="btn">Zapisz klub</button><button id="clearClub" class="btn-ghost">Wyczyść</button></div>
        </div>

        <div class="card">
          <h4>Dodaj mecz / wynik</h4>
          <input id="matchDate" class="input" type="date"/>
          <input id="matchTime" class="input" type="time"/>
          <input id="matchHome" class="input" placeholder="Gospodarz (nazwa klubu)"/>
          <input id="matchAway" class="input" placeholder="Gość (nazwa klubu)"/>
          <input id="matchPlace" class="input" placeholder="Miejsce"/>
          <select id="matchCat" class="input"><option>U10</option><option>U13</option><option>U16</option><option>U18</option></select>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="matchHomeGoals" class="input" type="number" min="0" placeholder="Gosp - pkt" style="width:48%"/>
            <input id="matchAwayGoals" class="input" type="number" min="0" placeholder="Gość - pkt" style="width:48%"/>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px"><button id="saveMatch" class="btn">Dodaj mecz</button><button id="clearMatch" class="btn-ghost">Wyczyść</button></div>
        </div>

        <div class="card" style="grid-column:1 / -1">
          <h4>Dodaj aktualność (ze zdjęciami)</h4>
          <input id="newsTitle" class="input" placeholder="Tytuł"/>
          <textarea id="newsContent" class="input" rows="3" placeholder="Treść"></textarea>
          <input id="newsFiles" type="file" accept="image/*" multiple class="input"/>
          <div style="margin-top:8px;display:flex;gap:8px"><button id="addNewsBtn" class="btn">Dodaj aktualność</button><button id="clearNewsForm" class="btn-ghost">Wyczyść</button></div>
        </div>
      </div>

      <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="exportAll" class="btn">Eksportuj wszystko (JSON)</button>
        <label class="btn-ghost" style="cursor:pointer;padding:8px 10px;border-radius:8px;">Import JSON<input id="importAll" type="file" accept=".json" style="display:none"/></label>
      </div>
    </div>
  </div>
</div>

<!-- Firebase + logic (module) -->
<script type="module">
  // ---------- KONFIGURACJA ADMINA ----------
  const ADMIN_PASS = 'Speedrower'; // <- zmień jeśli chcesz. UWAGA: widoczne w źródle.
  // -----------------------------------------

  // ---------- Firebase imports ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { getStorage, ref as sref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";
  // ---------------------------------------

  <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyDNi83_zoH8cDSpYoTS4XtoGLPDKnypG1A",
    authDomain: "speedrower-junior-league.firebaseapp.com",
    projectId: "speedrower-junior-league",
    storageBucket: "speedrower-junior-league.firebasestorage.app",
    messagingSenderId: "151487950214",
    appId: "1:151487950214:web:54742c6cae06f267661007",
    measurementId: "G-BTW6P3QMS3"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
  // Z konsoli Firebase -> Add Web App -> kopia firebaseConfig
  const firebaseConfig = {
 // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
};
  };
  // ---------------------------------------
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // --- UI refs ---
  const showBtns = document.querySelectorAll('[data-show]');
  const views = document.querySelectorAll('.view');
  const openPanelBtn = document.getElementById('openPanelBtn');
  const panelModal = document.getElementById('panelModal');
  const closePanel = document.getElementById('closePanel');
  const loginBtn = document.getElementById('loginBtn');
  const adminPasswordInput = document.getElementById('adminPassword');
  const adminControls = document.getElementById('adminControls');
  const loginForm = document.getElementById('loginForm');
  const adminStatus = document.getElementById('adminStatus');

  // view nav
  showBtns.forEach(b=> b.addEventListener('click', ()=> {
    const id=b.dataset.show;
    views.forEach(v=> v.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    window.scrollTo({top:0,behavior:'smooth'});
  }));
  // default
  views.forEach(v=> v.classList.add('hidden'));
  document.getElementById('home').classList.remove('hidden');

  // panel open/close
  openPanelBtn.addEventListener('click', ()=> {
    panelModal.classList.remove('hidden');
    // if already logged in (session), show admin controls
    if(sessionStorage.getItem('sr_admin')==='1') showAdminControls(true);
  });
  closePanel.addEventListener('click', ()=> panelModal.classList.add('hidden'));

  function showAdminControls(show){
    if(show){
      adminControls.classList.remove('hidden');
      loginForm.classList.add('hidden');
      adminStatus.textContent = 'Zalogowany (panel odblokowany)';
      sessionStorage.setItem('sr_admin','1');
    } else {
      adminControls.classList.add('hidden');
      loginForm.classList.remove('hidden');
      adminStatus.textContent = 'Panel zamknięty';
      sessionStorage.removeItem('sr_admin');
    }
  }

  // login with password (client-side)
  loginBtn.addEventListener('click', ()=> {
    const val = (adminPasswordInput.value||'').trim();
    if(!val) return alert('Wpisz hasło.');
    if(val === ADMIN_PASS){
      adminPasswordInput.value = '';
      showAdminControls(true);
      alert('Dostęp przyznany. Pamiętaj: hasło jest widoczne w kodzie strony — to szybkie, nie bardzo bezpieczne rozwiązanie.');
    } else {
      alert('Błędne hasło.');
    }
  });

  // If session active on page load, restore admin UI
  if(sessionStorage.getItem('sr_admin')==='1') showAdminControls(true);

  // ---------- HELPERS ----------
  function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
  function uid(p='id'){ return p + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,7); }

  // ========== NEWS (FireStore + Storage) ==========
  const newsList = document.getElementById('newsList');
  async function loadNews(){
    newsList.innerHTML = 'Ładowanie...';
    try {
      const q = query(collection(db,'aktualnosci'), orderBy('createdAt','desc'));
      const snap = await getDocs(q);
      newsList.innerHTML = '';
      if(snap.empty){ newsList.innerHTML = '<div class="small">Brak aktualności.</div>'; return; }
      snap.forEach(d=>{
        const n = d.data();
        const date = n.createdAt && n.createdAt.toDate ? n.createdAt.toDate().toLocaleString() : (n.date||'');
        const div = document.createElement('div'); div.className = 'card';
        let imgs = '';
        if(n.images && n.images.length) imgs = '<div class="news-images">' + n.images.map(u=> `<img src="${u}" onclick="window.open('${u}','_blank')">`).join('') + '</div>';
        div.innerHTML = `<strong>${escapeHtml(n.title)}</strong><div class="small">${date}${n.author?(' • '+escapeHtml(n.author)):""}</div><div style="margin-top:8px">${escapeHtml(n.content)}</div>${imgs}`;
        newsList.appendChild(div);
      });
    } catch(e){ newsList.innerHTML = '<div class="small">Błąd wczytywania aktualności.</div>'; console.error(e); }
  }

  async function uploadFiles(files){
    if(!files || files.length===0) return [];
    const urls = [];
    for(const f of files){
      const path = `news_images/${Date.now()}_${Math.random().toString(36).slice(2,8)}_${f.name}`;
      const ref = sref(storage, path);
      await uploadBytes(ref, f);
      const url = await getDownloadURL(ref);
      urls.push(url);
    }
    return urls;
  }

  document.getElementById('addNewsBtn').addEventListener('click', async ()=>{
    if(sessionStorage.getItem('sr_admin')!=='1') return alert('Zaloguj się hasłem w Panelu organizatora.');
    const title = document.getElementById('newsTitle').value.trim();
    const content = document.getElementById('newsContent').value.trim();
    const files = document.getElementById('newsFiles').files;
    if(!title || !content) return alert('Wypełnij tytuł i treść.');
    const btn = document.getElementById('addNewsBtn'); btn.disabled=true; btn.textContent='Dodawanie...';
    try {
      const imgs = await uploadFiles(files);
      await addDoc(collection(db,'aktualnosci'), { title, content, images: imgs, author: 'Organizer (hasło)', createdAt: serverTimestamp() });
      document.getElementById('newsTitle').value=''; document.getElementById('newsContent').value=''; document.getElementById('newsFiles').value='';
      alert('Dodano aktualność.');
      loadNews();
    } catch(e){ alert('Błąd: '+e.message); } finally { btn.disabled=false; btn.textContent='Dodaj aktualność'; }
  });

  // ========== CLUBS ==========
  const clubsList = document.getElementById('clubsList');
  async function loadClubs(){
    clubsList.innerHTML = '';
    try {
      const snap = await getDocs(collection(db,'kluby'));
      if(snap.empty){ clubsList.innerHTML = '<div class="small">Brak klubów.</div>'; return; }
      snap.forEach(s=>{
        const c = s.data();
        const div = document.createElement('div'); div.className='card';
        div.innerHTML = `<strong>${escapeHtml(c.name)}</strong><div class="small">${escapeHtml(c.city||'')} ${c.short?('• '+escapeHtml(c.short)):""}</div>
          <div style="margin-top:8px">${escapeHtml(c.description||'')}</div>
          ${sessionStorage.getItem('sr_admin')==='1' ? `<div style="margin-top:8px"><button class="btn-ghost" onclick="editClub('${s.id}')">Edytuj</button> <button class="btn-ghost" onclick="deleteClub('${s.id}')">Usuń</button></div>` : ''}`;
        clubsList.appendChild(div);
      });
    } catch(e){ clubsList.innerHTML = '<div class="small">Błąd ładowania klubów.</div>'; console.error(e); }
  }

  document.getElementById('saveClub').addEventListener('click', async ()=>{
    if(sessionStorage.getItem('sr_admin')!=='1') return alert('Zaloguj się hasłem.');
    const name = document.getElementById('clubName').value.trim(); if(!name) return alert('Nazwa klubu wymagana.');
    const data = {
      name,
      city: document.getElementById('clubCity').value.trim(),
      short: document.getElementById('clubShort').value.trim(),
      description: document.getElementById('clubDesc').value.trim(),
      achievements: (document.getElementById('clubAchievements').value||'').split(',').map(s=>s.trim()).filter(Boolean),
      roster: (document.getElementById('clubRoster').value||'').split(',').map(s=>s.trim()).filter(Boolean),
      categories: Array.from(document.getElementById('clubCats').selectedOptions).map(o=>o.value),
      createdAt: serverTimestamp(),
      author: 'Organizer (hasło)'
    };
    // Add new
    try {
      await addDoc(collection(db,'kluby'), data);
      alert('Dodano klub.');
      document.getElementById('clubName').value=''; document.getElementById('clubCity').value=''; document.getElementById('clubShort').value='';
      document.getElementById('clubDesc').value=''; document.getElementById('clubAchievements').value=''; document.getElementById('clubRoster').value='';
      Array.from(document.getElementById('clubCats').options).forEach(o=>o.selected=false);
      loadClubs();
    } catch(e){ alert('Błąd: '+e.message); }
  });

  window.editClub = async function(id){
    const d = await getDocs(collection(db,'kluby')); // simple fetch, then open in form by id (left as simple approach)
    alert('Edytowanie klubu możliwe przez eksport/import JSON lub w konsoli Firebase. Prosty edytor można dodać na żądanie.');
  };
  window.deleteClub = async function(id){
    if(!confirm('Usunąć klub?')) return;
    try { await deleteDoc(doc(db,'kluby',id)); loadClubs(); } catch(e){ alert('Błąd: '+e.message); }
  };
  document.getElementById('clearClub').addEventListener('click', ()=> {
    document.getElementById('clubName').value=''; document.getElementById('clubCity').value=''; document.getElementById('clubShort').value='';
    document.getElementById('clubDesc').value=''; document.getElementById('clubAchievements').value=''; document.getElementById('clubRoster').value='';
    Array.from(document.getElementById('clubCats').options).forEach(o=>o.selected=false);
  });

  // ========== MATCHES ==========
  const scheduleList = document.getElementById('scheduleList');
  async function loadMatches(){
    scheduleList.innerHTML = '';
    try {
      const snap = await getDocs(query(collection(db,'mecze'), orderBy('date','asc')));
      if(snap.empty){ scheduleList.innerHTML = '<div class="small">Brak meczów.</div>'; return; }
      const table = document.createElement('table'); table.className='table';
      table.innerHTML = '<thead><tr><th>Data</th><th>Godz.</th><th>Mecz</th><th>Kategoria</th><th>Miejsce</th><th>Wynik</th><th>Akcje</th></tr></thead>';
      const tb = document.createElement('tbody');
      snap.forEach(s=>{
        const m = s.data();
        const tr = document.createElement('tr');
        const res = (typeof m.homeGoals==='number' && typeof m.awayGoals==='number') ? `${m.homeGoals} : ${m.awayGoals}` : '-';
        tr.innerHTML = `<td>${escapeHtml(m.date||'')}</td><td>${escapeHtml(m.time||'')}</td><td>${escapeHtml(m.home)} — ${escapeHtml(m.away)}</td><td>${escapeHtml(m.category||'')}</td><td>${escapeHtml(m.place||'')}</td><td>${res}</td><td></td>`;
        const td = tr.querySelector('td:last-child');
        if(sessionStorage.getItem('sr_admin')==='1'){
          const del = document.createElement('button'); del.className='btn-ghost'; del.textContent='Usuń'; del.onclick = async ()=> { if(confirm('Usunąć mecz?')){ await deleteDoc(doc(db,'mecze',s.id)); loadMatches(); renderStandings(); } };
          td.appendChild(del);
        }
        tb.appendChild(tr);
      });
      table.appendChild(tb); scheduleList.appendChild(table);
    } catch(e){ scheduleList.innerHTML = '<div class="small">Błąd ładowania terminarza.</div>'; console.error(e); }
  }

  document.getElementById('saveMatch').addEventListener('click', async ()=>{
    if(sessionStorage.getItem('sr_admin')!=='1') return alert('Zaloguj się hasłem.');
    const date = document.getElementById('matchDate').value;
    const time = document.getElementById('matchTime').value;
    const home = document.getElementById('matchHome').value.trim();
    const away = document.getElementById('matchAway').value.trim();
    const place = document.getElementById('matchPlace').value.trim();
    const cat = document.getElementById('matchCat').value;
    const hg = document.getElementById('matchHomeGoals').value;
    const ag = document.getElementById('matchAwayGoals').value;
    if(!date || !home || !away) return alert('Wypełnij datę, gospodarza i gościa.');
    const data = { date, time, home, away, place, category:cat, homeGoals: hg===''?null: Number(hg), awayGoals: ag===''?null: Number(ag), createdAt: serverTimestamp(), author: 'Organizer (hasło)' };
    try { await addDoc(collection(db,'mecze'), data); document.getElementById('matchDate').value=''; document.getElementById('matchTime').value=''; document.getElementById('matchHome').value=''; document.getElementById('matchAway').value=''; loadMatches(); renderStandings(); alert('Dodano mecz.'); } catch(e){ alert('Błąd: '+e.message); }
  });

  // ========== STANDINGS ==========
  async function renderStandings(){
    const el = document.getElementById('standingsList');
    el.innerHTML = '';
    try {
      const clubsSnap = await getDocs(collection(db,'kluby'));
      const matchesSnap = await getDocs(collection(db,'mecze'));
      if(clubsSnap.empty || matchesSnap.empty){ el.innerHTML = '<div class="small">Brak danych do wyliczeń.</div>'; return; }
      const map = {};
      clubsSnap.forEach(c => { const d = c.data(); map[d.name] = { club: d.name, MP:0,P:0,W:0,D:0,L:0,GF:0,GA:0,GD:0 }; });
      matchesSnap.forEach(mSnap => {
        const m = mSnap.data();
        if(typeof m.homeGoals!=='number' || typeof m.awayGoals!=='number') return;
        if(!map[m.home] || !map[m.away]) return;
        map[m.home].MP++; map[m.away].MP++;
        map[m.home].GF += m.homeGoals; map[m.home].GA += m.awayGoals;
        map[m.away].GF += m.awayGoals; map[m.away].GA += m.homeGoals;
        if(m.homeGoals>m.awayGoals){ map[m.home].W++; map[m.home].P+=3; map[m.away].L++; }
        else if(m.homeGoals<m.awayGoals){ map[m.away].W++; map[m.away].P+=3; map[m.home].L++; }
        else { map[m.home].D++; map[m.away].D++; map[m.home].P++; map[m.away].P++; }
      });
      Object.values(map).forEach(r=> r.GD = r.GF - r.GA);
      const sorted = Object.values(map).sort((a,b)=> (b.P - a.P) || (b.GD - a.GD) || (b.GF - a.GF));
      const tbl = document.createElement('table'); tbl.className='table';
      tbl.innerHTML = '<thead><tr><th>#</th><th>Klub</th><th>MP</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>GD</th></tr></thead>';
      const tbody = document.createElement('tbody');
      sorted.forEach((r,i)=> { const tr = document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(r.club)}</td><td>${r.MP}</td><td>${r.P}</td><td>${r.W}</td><td>${r.D}</td><td>${r.L}</td><td>${r.GF}</td><td>${r.GA}</td><td>${r.GD}</td>`; tbody.appendChild(tr); });
      tbl.appendChild(tbody); el.appendChild(tbl);
    } catch(e){ el.innerHTML = '<div class="small">Błąd przy wyliczaniu tabeli.</div>'; console.error(e); }
  }

  // ========== EXPORT / IMPORT ==========
  document.getElementById('exportAll').addEventListener('click', async ()=>{
    if(!confirm('Pobrać backup wszystkich kolekcji?')) return;
    try {
      const [klubySnap, meczeSnap, newsSnap] = await Promise.all([getDocs(collection(db,'kluby')), getDocs(collection(db,'mecze')), getDocs(collection(db,'aktualnosci'))]);
      const data = { kluby: klubySnap.docs.map(d=>({id:d.id,data:d.data()})), mecze: meczeSnap.docs.map(d=>({id:d.id,data:d.data()})), aktualnosci: newsSnap.docs.map(d=>({id:d.id,data:d.data()})) };
      const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'speedrower_backup.json'; a.click(); URL.revokeObjectURL(url);
    } catch(e){ alert('Błąd eksportu: '+e.message); }
  });

  document.getElementById('importAll').addEventListener('change', async (e)=>{
    if(sessionStorage.getItem('sr_admin')!=='1') return alert('Zaloguj się hasłem.');
    const f = e.target.files[0]; if(!f) return;
    const txt = await f.text();
    try {
      const json = JSON.parse(txt);
      if(json.kluby){ for(const k of json.kluby) await addDoc(collection(db,'kluby'), k.data); }
      if(json.mecze){ for(const m of json.mecze) await addDoc(collection(db,'mecze'), m.data); }
      if(json.aktualnosci){ for(const n of json.aktualnosci) await addDoc(collection(db,'aktualnosci'), n.data); }
      alert('Import zakończony.'); loadClubs(); loadMatches(); loadNews(); renderStandings();
    } catch(err){ alert('Błąd importu: '+err.message); }
  });

  // init loads
  loadNews(); loadClubs(); loadMatches(); renderStandings();

</script>
</body>
</html>
