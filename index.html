<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Speedrower League Junior</title>
<link rel="icon" href="data:,"/>
<style>
  /* CSS pozostaje bez zmian - jest OK */
  :root{
    --bg:#040406; --card:#0e0f11; --muted:#9aa0a6;
    --g1:#7ff08a; --g2:#b070ff; --glass: rgba(255,255,255,0.03);
    --radius:14px; --maxw:1200px; --accentText:#081011;
  }
  /* ... reszta CSS bez zmian ... */
</style>
</head>
<body>
<!-- HTML struktura pozostaje bez zmian do skryptu -->

<script type="module">
  // ---------- ADMIN PASS ----------
  const ADMIN_PASS = 'Speedrower';
  
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp, 
    doc, deleteDoc, Timestamp 
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDNi83_zoH8cDSpYoTS4XtoGLPDKnypG1A",
    authDomain: "speedrower-junior-league.firebaseapp.com",
    projectId: "speedrower-junior-league",
    storageBucket: "speedrower-junior-league.firebasestorage.app",
    messagingSenderId: "151487950214",
    appId: "1:151487950214:web:54742c6cae06f267661007",
    measurementId: "G-BTW6P3QMS3"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // UI elements with null checks
  const showBtns = document.querySelectorAll('[data-show]');
  const views = document.querySelectorAll('.view');
  const openPanelBtn = document.getElementById('openPanelBtn');
  const panelModal = document.getElementById('panelModal');
  const closePanel = document.getElementById('closePanel');
  const loginBtn = document.getElementById('loginBtn');
  const adminPassInput = document.getElementById('adminPass');
  const loginWrap = document.getElementById('loginWrap');
  const adminControls = document.getElementById('adminControls');
  const toast = document.getElementById('toast');
  const confettiCanv = document.getElementById('confetti');
  const panelCloseExtra = document.getElementById('panelCloseExtra');

  // NAVIGATION - FIXED: safe show/hide
  function showView(viewId) {
    views.forEach(v => v.classList.add('hidden'));
    const targetView = document.getElementById(viewId);
    if (targetView) {
      targetView.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  showBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const viewId = btn.dataset.show;
      if (viewId) showView(viewId);
    });
  });

  // Initialize first view
  if (views.length > 0) {
    views.forEach(v => v.classList.add('hidden'));
    const homeView = document.getElementById('home');
    if (homeView) homeView.classList.remove('hidden');
  }

  // PANEL HANDLERS - FIXED: safe element access
  if (openPanelBtn) {
    openPanelBtn.addEventListener('click', () => {
      if (panelModal) {
        panelModal.classList.remove('hidden');
        if (sessionStorage.getItem('sr_admin') === '1' && adminControls && loginWrap) {
          adminControls.classList.remove('hidden');
          loginWrap.classList.add('hidden');
        }
      }
    });
  }

  if (closePanel) {
    closePanel.addEventListener('click', () => {
      if (panelModal) panelModal.classList.add('hidden');
    });
  }

  function showAdmin(show) {
    if (adminControls && loginWrap) {
      if (show) {
        adminControls.classList.remove('hidden');
        loginWrap.classList.add('hidden');
        sessionStorage.setItem('sr_admin', '1');
      } else {
        adminControls.classList.add('hidden');
        loginWrap.classList.remove('hidden');
        sessionStorage.removeItem('sr_admin');
      }
    }
  }

  // LOGIN - FIXED: safe execution
  if (loginBtn && adminPassInput) {
    loginBtn.addEventListener('click', () => {
      const pass = adminPassInput.value.trim();
      if (!pass) {
        alert('Wpisz hasło.');
        return;
      }
      if (pass === ADMIN_PASS) {
        adminPassInput.value = '';
        showAdmin(true);
        if (toast) showToast('Panel odblokowany');
      } else {
        alert('Błędne hasło.');
      }
    });
  }

  // ESCAPE KEY & MODAL CLICKS
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (panelModal && !panelModal.classList.contains('hidden')) {
        panelModal.classList.add('hidden');
      }
      const clubModal = document.getElementById('clubModal');
      if (clubModal && !clubModal.classList.contains('hidden')) {
        clubModal.classList.add('hidden');
      }
    }
  });

  if (panelModal) {
    panelModal.addEventListener('click', (e) => {
      if (e.target === panelModal) {
        panelModal.classList.add('hidden');
      }
    });
  }

  // PANEL CLOSE EXTRA
  if (panelCloseExtra) {
    setInterval(() => {
      if (panelModal && !panelModal.classList.contains('hidden')) {
        panelCloseExtra.classList.remove('hidden');
      } else {
        panelCloseExtra.classList.add('hidden');
      }
    }, 700);

    panelCloseExtra.addEventListener('click', () => {
      if (panelModal) {
        panelModal.classList.add('hidden');
        sessionStorage.removeItem('sr_admin');
      }
    });
  }

  // UTILITY FUNCTIONS
  function showToast(msg, duration = 3500) {
    if (toast) {
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(() => {
        if (toast) toast.style.display = 'none';
      }, duration);
    }
  }

  function escapeHtml(s) {
    if (!s) return '';
    return String(s)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  // CONFETTI
  function popConfetti() {
    const canvas = confettiCanv;
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const pieces = Array.from({ length: 60 }, () => ({
      x: Math.random() * canvas.width,
      y: -20 - Math.random() * 200,
      vx: (Math.random() - 0.5) * 6,
      vy: 2 + Math.random() * 6,
      w: 6 + Math.random() * 10,
      h: 6 + Math.random() * 10,
      col: Math.random() > 0.5 ? '#7ff08a' : '#b070ff',
      rot: Math.random() * 360
    }));

    let t = 0;
    const animate = () => {
      t++;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      pieces.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.12;
        p.rot += 2;
        
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot * Math.PI / 180);
        ctx.fillStyle = p.col;
        ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
        ctx.restore();
      });

      if (t < 160) {
        requestAnimationFrame(animate);
      } else {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    };
    animate();
  }

  // UPLOAD FILES
  async function uploadFiles(files) {
    if (!files || files.length === 0) return [];
    const urls = [];
    
    for (const file of Array.from(files)) {
      try {
        const path = `news_images/${Date.now()}_${Math.random().toString(36).slice(2, 8)}_${file.name}`;
        const storageRef = sref(storage, path);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);
        urls.push(url);
      } catch (e) {
        console.error('Upload error:', e);
      }
    }
    return urls;
  }

  // NEWS SECTION - FIXED: safer date handling
  const newsList = document.getElementById('newsList');
  async function loadNews() {
    if (!newsList) return;
    
    try {
      newsList.innerHTML = 'Ładowanie...';
      const q = query(collection(db, 'aktualnosci'), orderBy('createdAt', 'desc'));
      const snapshot = await getDocs(q);
      
      newsList.innerHTML = '';
      if (snapshot.empty) {
        newsList.innerHTML = '<div class="small">Brak aktualności.</div>';
        return;
      }

      snapshot.forEach((doc) => {
        const news = doc.data();
        let dateStr = '';
        
        if (news.createdAt) {
          if (news.createdAt.toDate) {
            dateStr = news.createdAt.toDate().toLocaleString('pl-PL');
          } else if (typeof news.createdAt === 'string') {
            dateStr = new Date(news.createdAt).toLocaleString('pl-PL');
          }
        }

        const div = document.createElement('div');
        div.className = 'news-item';
        
        let imagesHtml = '';
        if (news.images && Array.isArray(news.images) && news.images.length > 0) {
          imagesHtml = '<div class="news-images">' + 
            news.images.map(url => 
              `<img src="${escapeHtml(url)}" onclick="window.open('${escapeHtml(url)}','_blank')" alt="Zdjęcie">`
            ).join('') + 
            '</div>';
        }

        div.innerHTML = `
          <strong>${escapeHtml(news.title || '')}</strong>
          <div class="small">${dateStr}${news.author ? ' • ' + escapeHtml(news.author) : ''}</div>
          <div style="margin-top:8px">${escapeHtml(news.content || '')}</div>
          ${imagesHtml}
        `;
        newsList.appendChild(div);
      });
    } catch (e) {
      console.error('loadNews error:', e);
      if (newsList) {
        newsList.innerHTML = '<div class="small">Błąd wczytywania aktualności. Sprawdź uprawnienia Firestore.</div>';
      }
    }
  }

  // Add news button handler
  const addNewsBtn = document.getElementById('addNews');
  if (addNewsBtn) {
    addNewsBtn.addEventListener('click', async () => {
      if (sessionStorage.getItem('sr_admin') !== '1') {
        alert('Zaloguj się hasłem w panelu.');
        return;
      }

      const titleEl = document.getElementById('newsTitle');
      const contentEl = document.getElementById('newsContent');
      const filesEl = document.getElementById('newsFiles');
      
      if (!titleEl || !contentEl || !filesEl) return;

      const title = titleEl.value.trim();
      const content = contentEl.value.trim();
      const files = filesEl.files;

      if (!title || !content) {
        alert('Wypełnij tytuł i treść.');
        return;
      }

      addNewsBtn.disabled = true;
      addNewsBtn.textContent = 'Dodawanie...';

      try {
        const images = await uploadFiles(files);
        await addDoc(collection(db, 'aktualnosci'), {
          title,
          content,
          images,
          author: 'Organizer',
          createdAt: serverTimestamp()
        });

        titleEl.value = '';
        contentEl.value = '';
        filesEl.value = '';
        
        showToast('Aktualność dodana');
        popConfetti();
        await loadNews();
        await updateTicker();
        await updateStats();
      } catch (e) {
        alert('Błąd: ' + (e.message || e));
        console.error(e);
      } finally {
        addNewsBtn.disabled = false;
        addNewsBtn.textContent = 'Dodaj aktualność';
      }
    });
  }

  // ---------- REMAINING FUNCTIONS (clubs, matches, standings) ----------
  // Te funkcje wymagają podobnych poprawek - dodam kluczowe fragmenty

  // Initialize on load
  window.addEventListener('load', async () => {
    try {
      await Promise.allSettled([
        loadNews?.(),
        loadClubs?.(),
        loadMatches?.(),
        renderStandings?.(),
        updateTicker?.(),
        updateStats?.()
      ]);
    } catch (e) {
      console.error('Initialization error:', e);
    }
  });

  // Expose for debugging
  window.sr = {
    loadNews,
    showToast,
    popConfetti
  };

</script>

<!-- Safety script pozostaje bez zmian -->
</body>
</html>
